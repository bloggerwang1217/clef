# clef-piano-base Training Configuration
# =======================================
#
# ISMIR 2026 target: Serial encoder (Octopus → Flow → Swin pitch space)
#
# Architecture: bio-inspired serial pipeline
# - Octopus2D = CN octopus cells (cross-frequency onset detection)
# - Flow = IC harmonic integration (mel → pitch space)
# - Swin = A1 cortex (multi-scale 2D on pitch space)

# =============================================================================
# Seeds
# =============================================================================
seed:
  data_augmentation: 0
  training: 1234

# =============================================================================
# Model Architecture
# =============================================================================
model:
  name: "clef-piano-base"

  # Encoder: Swin V2 (frozen)
  swin_model: "microsoft/swinv2-tiny-patch4-window8-256"
  swin_dims: [96, 192, 384, 768]
  freeze_encoder: true

  # Serial encoder: Swin eats Flow output (pitch space)
  swin_on_pitch_space: true
  swin_pool_strides: [1, 1, 1, 1]  # Flow already reduced T, no extra pool needed

  # Octopus2D (CN octopus cells: cross-frequency onset detection)
  use_octopus: true
  octopus_freq_kernel: 31      # ~4 harmonics span
  octopus_time_kernel: 3       # onset transient (30ms)
  octopus_channels: 32         # different onset pattern detectors
  octopus_time_pool_stride: 2  # T → T/2
  octopus_freq_pool_stride: 4  # 128 mels → 32 freq bins

  # HarmonizingFlow (IC harmonic integration: mel → pitch space)
  use_flow: true
  n_harmonics: 6
  flow_pool_stride: 4          # T → T/4
  use_temporal_cnn: false      # Serial mode: no CNN, Octopus provides onset

  # Deformable Attention (CLEF)
  d_model: 512
  n_heads: 8
  n_levels: 6                  # Octopus + Flow + S0-S3
  ff_dim: 2048
  dropout: 0.1

  n_points_freq: 2
  n_points_time: 2
  freq_offset_scale: 1.0
  time_offset_scale: 1.0

  use_time_prior: true
  use_freq_prior: true
  n_freq_groups: 4
  refine_range: 0.1

  bridge_layers: 2

  # Decoder (Jamba-style: 4 Mamba + 2 SA)
  decoder_layer_types: ["mamba", "mamba", "sa", "mamba", "mamba", "sa"]
  mamba_d_state: 128
  mamba_d_conv: 4
  mamba_expand: 2
  decoder_layers: 6
  max_seq_len: 16384
  vocab_size: 272

  label_smoothing: 0.0

# =============================================================================
# Data
# =============================================================================
data:
  datasets:
    - musesyn
    - humsyn

  vocabulary: "zeng_extended"

  audio:
    sample_rate: 16000
    feature: "log_mel"
    n_mels: 128
    n_fft: 2048
    hop_length: 160             # 100 fps
    f_min: 27.5                 # A0
    f_max: 7040.0               # 8 octaves

  chunking:
    enabled: true
    chunk_frames: 24000         # 4 min
    overlap_frames: 12000       # 2 min overlap
    min_chunk_ratio: 0.5

  augmentation:
    transpose:
      enabled: true
    soundfonts:
      - "TimGM6mb.sf2"
      - "FluidR3_GM.sf2"
      - "UprightPianoKW-20220221.sf2"
      - "SalamanderGrandPiano-V3+20200602.sf2"
    loudness_norm:
      target_lufs: -15

# =============================================================================
# Training
# =============================================================================
training:
  distributed:
    enabled: true
    backend: "nccl"
    num_gpus: 2

  precision: "bf16"
  batch_size: 1
  gradient_accumulation_steps: 2
  effective_batch_size: 4

  learning_rate: 2.0e-5
  weight_decay: 0.01
  max_epochs: 50
  warmup_steps: 5000
  gradient_clip: 1.0

  save_every_n_epochs: 10
  save_best: true
  save_last: true
  early_stopping_patience: 5

  wandb:
    enabled: true
    project: "clef-piano-base"
    tags: ["piano", "a2s", "serial-encoder", "rtx3090"]

# =============================================================================
# Paths
# =============================================================================
paths:
  data_dir: "data/datasets"
  output_dir: "data/experiments/clef_piano_base"
  checkpoint_dir: "checkpoints/clef_piano_base"
