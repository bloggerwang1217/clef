# ASAP éŒ¯èª¤æª”æ¡ˆåˆ†æå ±å‘Š

---

## ğŸŸ¢ å…¨å±€ç‹€æ…‹ç¸½è¦½

### Pipeline æ¶æ§‹

```
MusicXML â”€â”€â–¶ Full Score Kern â”€â”€â–¶ Upper/Lower Kern â”€â”€â–¶ PKL (Zeng)
            (éšæ®µ 1)            (éšæ®µ 2)             (éšæ®µ 3)
            converter21         è­œè¡¨åˆ†é›¢+åˆ‡åˆ†         ç·¨ç¢¼
```

### éšæ®µ 1 è™•ç†ç‹€æ…‹

| Split | æˆåŠŸç‡ | å¤±æ•—åŸå›  |
|-------|--------|----------|
| **Test Set** | **25/25 æ›²ç›® (100%)** âœ… | ç„¡ |
| **Training Set** | 24/25 æ›²ç›® (96%) | converter21 v4.0.0 bug |

### âš ï¸ å”¯ä¸€å‰©é¤˜çš„éšæ®µ 1 éŒ¯èª¤

| æ›²ç›® | Split | éŒ¯èª¤é¡å‹ | èªªæ˜ |
|------|-------|----------|------|
| Chopin#Scherzos#31 | Training | `list assignment index out of range` | converter21 v4.0.0 å·²çŸ¥ bug |

### Performance å±¤ç´šçµ±è¨ˆ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   161 performances â”‚ (Test Set ç¸½æ•¸)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ éšæ®µ 1 å¤±æ•—        â”‚         â”‚ éšæ®µ 1 æˆåŠŸ            â”‚
    â”‚ 0 performances    â”‚         â”‚ 161 performances      â”‚
    â”‚ (0 æ›²ç›®) âœ…        â”‚         â”‚ (25 æ›²ç›®) âœ…           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ç„¡éŸ³æª”ï¼ˆé MAESTROï¼‰   â”‚         â”‚ æœ‰éŸ³æª”ï¼ˆMAESTROï¼‰          â”‚
              â”‚ â†’ è³‡æ–™é›†é™åˆ¶          â”‚         â”‚ â†’ âœ… å¯ç”¨æ–¼ Zeng          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã€Œç„¡éŸ³æª”ã€èªªæ˜

ASAP è³‡æ–™é›†åŒ…å«å…©ç¨® performancesï¼š
- **MAESTRO å­é›†**ï¼ˆ519 å€‹ï¼‰ï¼šæœ‰éŸ³æª”ï¼Œä¾†è‡ª MAESTRO é‹¼ç´éŒ„éŸ³è³‡æ–™é›†
- **é MAESTRO**ï¼ˆ548 å€‹ï¼‰ï¼šåªæœ‰ MIDI + å°é½Šæ¨™è¨»ï¼Œç„¡éŒ„éŸ³

é MAESTRO çš„ performances æ˜¯ ASAP ä½œè€…æ‰‹å‹•å°é½Šçš„é¡å¤–è³‡æ–™ï¼Œæœ¬ä¾†å°±æ²’æœ‰éŸ³æª”ã€‚
é€™ä¸æ˜¯ pipeline éŒ¯èª¤ï¼Œæ˜¯è³‡æ–™é›†è¨­è¨ˆçš„é™åˆ¶ã€‚

---

## è™•ç†çµæœçµ±è¨ˆï¼ˆ2026-01-17 run_asap_new.shï¼‰

### ç”Ÿæˆçµæœ

| é¡å‹ | æ•¸é‡ |
|------|------|
| Test PKL | 9,363 å€‹ |
| Train PKL | 5,613 å€‹ |
| [ERROR] | 1 å€‹ |
| [SKIP] | ~8,269 å€‹ï¼ˆæ­£å¸¸éæ¿¾ï¼‰ |

### [SKIP] é¡å‹èªªæ˜

é€™äº›æ˜¯ Zeng pipeline å¾ŒçºŒè™•ç†éšæ®µçš„æ­£å¸¸éæ¿¾ï¼Œä¸æ˜¯ converter21 éŒ¯èª¤ï¼š

| åŸå›  | èªªæ˜ |
|------|------|
| Audio duration out of range | Zeng è¦æ±‚ chunk é•·åº¦ 4-12 ç§’ |
| process_voices() failed | è§£æ dotted duration å¦‚ `4.` æ™‚çš„ int() éŒ¯èª¤ |
| kern.clean() failed | clean_kern æœªè™•ç†çš„ notation |
| tosequence() returned None | åºåˆ—åŒ–å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ vocab ä¸æ”¯æ´çš„ tokenï¼‰ |
| Wrong measure count | ä¸Šä¸‹è­œè¡¨å°ç¯€æ•¸å°ä¸ä¸Š |

---

## æ­·å²å•é¡Œåˆ†æ

### converter21 v4.0.0 Index Bugï¼ˆç„¡æ³•ä¿®å¾©ï¼‰

#### æª”æ¡ˆè³‡è¨Š
- **æ›²ç›®**: Chopin - Scherzo No. 3, Op. 39
- **æª”æ¡ˆè·¯å¾‘**: `/home/bloggerwang/asap-dataset/Chopin/Scherzos/31/xml_score.musicxml`
- **éŒ¯èª¤é¡å‹**: `list assignment index out of range`
- **éŒ¯èª¤ä½ç½®**: converter21 `m21utilities.py:4542`

#### Bug æœ¬è³ª

é€™æ˜¯ä¸€å€‹åœ¨ **converter21 v4.0.0** ä¸­ç™¼ç¾çš„ç´¢å¼•è¶Šç•ŒéŒ¯èª¤ï¼Œå±¬æ–¼æ–°ç‰ˆæœ¬å¼•å…¥çš„è¿´æ­¸æ€§éŒ¯èª¤ã€‚

#### å•é¡Œæ ¹æº

éŒ¯èª¤ç™¼ç”Ÿåœ¨ MusicXML åˆ° Kern è½‰æ›éç¨‹ä¸­çš„ã€Œå°ç¯€å¹³è¡¡ã€æ©Ÿåˆ¶ï¼š

1. **å›ºå®šé•·åº¦åˆ—è¡¨**: `partMeasures` åœ¨è™•ç†å‰é å…ˆå»ºç«‹ï¼Œé•·åº¦åŸºæ–¼åŸå§‹ MusicXML å„è²éƒ¨çš„å°ç¯€ç¸½æ•¸
2. **å‹•æ…‹æ’å…¥é‚è¼¯**: ç•¶åµæ¸¬åˆ°æŸå€‹ Part çš„å°ç¯€æ•¸å°‘æ–¼æœ€å¤§å€¼æ™‚ï¼Œæœƒå˜—è©¦æ’å…¥ç©ºç™½å°ç¯€
3. **ç´¢å¼•è¶Šç•Œ**: æ’å…¥æ–°å°ç¯€åˆ° music21 Stream å¾Œï¼Œå˜—è©¦ç”¨å›ºå®šç´¢å¼•å¯«å› `partMeasures` åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤

#### ç¨‹å¼ç¢¼å•é¡Œ

**éŒ¯èª¤ä½ç½®**: `converter21/shared/m21utilities.py:4542`

**åŸå§‹éŒ¯èª¤ç¨‹å¼ç¢¼**:
```python
# ç¬¬ 4508-4510 è¡Œï¼šå»ºç«‹å›ºå®šé•·åº¦åˆ—è¡¨
partMeasures: list[list[m21.stream.Measure]] = [
    list(part[m21.stream.Measure]) for part in parts
]

# ç¬¬ 4523 è¡Œï¼šæª¢æŸ¥å°ç¯€æ•¸ä¸è¶³
if msIdx >= numMeasuresInParts[partIdx]:
    # ç¬¬ 4531 è¡Œï¼šæ­£ç¢ºåœ° append åˆ° parts
    parts[partIdx].append(emptyMeas)

# ç¬¬ 4542 è¡Œï¼šBUGï¼å˜—è©¦ç”¨ç´¢å¼•è³¦å€¼åˆ°å›ºå®šé•·åº¦åˆ—è¡¨
partMeasures[partIdx][msIdx] = emptyMeas  # IndexError!
```

**å•é¡Œåˆ†æ**:
1. `partMeasures` åœ¨ç¬¬ 4508-4510 è¡Œå»ºç«‹ç‚ºå›ºå®šé•·åº¦åˆ—è¡¨
2. ç•¶éœ€è¦è£œå……ç©ºç™½å°ç¯€æ™‚ï¼Œ`parts[partIdx]` æ­£ç¢ºåœ°ä½¿ç”¨ `append()`
3. ä½† `partMeasures[partIdx]` å˜—è©¦ç”¨ç´¢å¼•ç›´æ¥è³¦å€¼ï¼Œå°è‡´è¶Šç•ŒéŒ¯èª¤

**æ­£ç¢ºçš„ä¿®å¾©æ–¹å¼**:
```python
# ä¿®æ­£ç¬¬ 4542 è¡Œ
if msIdx < len(partMeasures[partIdx]):
    partMeasures[partIdx][msIdx] = emptyMeas
else:
    partMeasures[partIdx].append(emptyMeas)
```

#### è§¸ç™¼æ¢ä»¶

**ç‚ºä½•æ˜¯é€™é¦– Scherzoï¼Ÿ**

æ ¹æ“šåŸ·è¡Œæ—¥èªŒé¡¯ç¤ºï¼š
- ç³»çµ±åµæ¸¬åˆ° measure 780 éœ€è¦è¢«åŠ åˆ° part 0
- ä½† `partMeasures[0]` çš„é•·åº¦åªæœ‰ 779
- å˜—è©¦ `partMeasures[0][780] = emptyMeas` æ™‚ç™¼ç”Ÿ IndexError

**æ¨‚æ›²ç‰¹å¾µ**:
1. **æ¨‚æ›²è¦æ¨¡**: é•·é” 780 å°ç¯€çš„å¤§å‹ä½œå“
2. **æœ€å¾Œä¸€å°ç¯€å…§å®¹**:
   - åŒ…å« 2 å€‹ staves çš„æ­£å¸¸é‹¼ç´è­œ
   - æœ‰æ­£ç¢ºçš„çµæŸæ¨™è¨˜ï¼š`<barline location="right"><bar-style>light-heavy</bar-style>`
   - åŒ…å« grace notesã€fermataã€octave shiftsã€pedal markings
   - æ­£å¸¸çš„ 4/4 å°ç¯€æ™‚å€¼ï¼ˆ240 durationï¼‰
3. **è²éƒ¨ä¸å°é½Š**: MusicXML å°å‡ºæ™‚ï¼Œä¸åŒ Staff é–“çš„å°ç¯€æ•¸å­˜åœ¨å¾®å°å·®ç•°

#### è§£æ±ºæ–¹æ¡ˆ

- ç­‰å¾… converter21 v4.0.1 ä¿®å¾©
- å‘ converter21 ä½œè€… Greg Chapman å›å ±æ­¤å•é¡Œ
