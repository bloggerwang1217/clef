## ~~待討論問題~~：決策記錄 - 為何選擇 **Kern 而非 ABC Notation？

### 原始考量

在計劃初期，我們曾考慮採用 **ABC Notation** 作為 Autoregressive Model 的輸出格式，基於 Yang et al. (2025) LEGATO 模型的成功經驗。然而，在深入分析多軌輸出需求後，我們發現了關鍵問題：**ABC Notation 的多軌支援能力有限，無法有效處理複雜的多聲部音樂。**

### 相關文獻中的多軌處理策略

除了 Yang et al. (2025) 之外，以下幾篇論文涉及處理或輸出**多軌（Multi-track）**或**多聲部（Polyphonic）**的樂譜，主要針對「鋼琴（雙譜表）」或「弦樂四重奏（四部合奏）」：

#### 1. Zeng et al. (2024) - 針對鋼琴的雙軌分層解碼

- **多軌處理方式**：設計了一個**分層解碼器（Hierarchical Decoder）**。在解碼出小節（Bar）資訊後，分岔出兩個獨立的「音符級解碼器（Note-level Decoders）」，分別負責預測：
  - **下行譜表（Lower staff）**：通常對應左手
  - **上行譜表（Upper staff）**：通常對應右手
- **輸出格式**：分開預測的 **\*\*Kern** 格式序列

#### 2. Alfaro-Contreras et al. (2024) - 針對弦樂四重奏的序列化方法

- **多軌處理方式**：使用 **Transformer** 解碼器輸出單一序列，透過特殊編碼方式代表多軌資訊
- **輸出格式**：改進的 **\*\*Kern** 格式
- **如何表示多軌**：標準的 Kern 格式使用「Spine（脊/列）」來代表不同的聲部或樂器。作者引入了 **`<coc>` (Change of Column)** Token，當模型輸出 `<coc>` 時，代表從當前的樂器軌道切換到下一個樂器軌道（例如從大提琴切換到中提琴），從而將多軌並行的樂譜「攤平」為一條長序列。

#### 3. Román et al. (2019) - 針對四重奏與聖詠曲的端到端轉譜

- **多軌處理方式**：使用卷積循環神經網路（CRNN）配合 CTC Loss 直接預測樂譜符號
- **輸出格式**：**\*\*Kern** 格式
- **如何表示多軌**：與 Alfaro-Contreras 類似，Kern 格式本身就是設計來處理多聲部的（以 Tab 分隔不同樂器軌）。模型輸出的文本序列中包含了這些分隔符，代表它能同時輸出多個樂器的聲部。

#### 4. Mayer et al. (2024) - 針對鋼琴樂譜的 OMR

- **多軌處理方式**：鋼琴樂譜包含大譜表（Grand Staff），即同時包含高音與低音譜表，且聲部結構複雜
- **輸出格式**：**Linearized MusicXML (LMX)**
- **如何表示多軌**：定義了一種將 MusicXML 樹狀結構線性化的方法。LMX 格式透過特定的 Token（如 `staff:1`, `staff:2` 或 `voice:1`）來標記當前符號屬於哪一個譜表或聲部，從而讓序列模型能夠輸出多軌結構。

### 文獻比較總結

| 論文                        | 任務類型       | 目標樂器/編制        | 使用格式 | 多軌處理策略                                               |
| :-------------------------- | :------------- | :------------------- | :------- | :--------------------------------------------------------- |
| **Zeng et al. (2024)**      | A2S (音訊轉譜) | 鋼琴 (2 Staves)      | **Kern   | **雙解碼器**：物理上分開兩個解碼器分別預測上下譜表         |
| **Alfaro-Contreras (2024)** | A2S (音訊轉譜) | 弦樂四重奏 (4 Inst.) | **Kern   | **序列化**：使用 `<coc>` Token 在單一序列中切換不同樂器軌  |
| **Román et al. (2019)**     | A2S (音訊轉譜) | 四重奏/聖詠曲        | **Kern   | **序列化**：直接預測包含多軌分隔符的 Kern 文本             |
| **Mayer et al. (2024)**     | OMR (影像轉譜) | 鋼琴 (Grand Staff)   | **LMX**  | **序列化**：使用 Linearized MusicXML，透過標籤定義譜表歸屬 |

### 最終決策：採用 **Kern 格式

**決策理由**：

1. **多軌需求明確**：
   - 鋼琴音樂需要雙譜表（大譜表，Grand Staff）
   - 室內樂（弦樂四重奏、木管五重奏）需要 4-5 軌
   - 限制為單旋律將嚴重限縮研究應用範圍

2. **格式比較結論**：
   - **\*\*Kern**：天生支援多軌（Tab 分隔 Spine），時間對齊明確
   - **ABC**：多軌支援弱（`V:` 標籤），時間對齊隱性（需數拍子）
   - **MusicXML**：過於冗長（Verbose），不適合序列模型

3. **技術可行性**：
   - Alfaro-Contreras et al. (2024) 已驗證 **Kern + `<coc>` Token 的成功
   - 序列化策略成熟，可直接套用
   - KernScores 資料集提供 108K+ 高品質訓練資料

4. **避免過度工程化**：
   - 自定義 ABC 擴展需要大量後處理工程
   - 雙解碼器架構（Zeng et al.）增加系統複雜度
   - **Kern 提供「開箱即用」的多軌解決方案

### 實施策略

1. **資料預處理**：將所有資料集（PDMX, ASAP, Vienna 4x22）轉換為 **Kern 格式
2. **序列化**：採用 `<coc>` Token 攤平多軌結構為單一序列
3. **後處理**：**Kern → MusicXML 轉換（利用 Humdrum Toolkit）
4. **評估**：使用 TEDn (基於 MusicXML) 與 MV2H 雙指標

**註**：本研究聚焦於古典音樂與室內樂的高精度轉譜，因此選用音樂學標準資料集（KernScores, ASAP）而非流行音樂資料集。
